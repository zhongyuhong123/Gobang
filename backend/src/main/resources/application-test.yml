# Come 下棋 - 测试环境配置
# 测试环境配置文件 - 用于集成测试和预发布环境

spring:
  profiles:
    active: test
  
  # 应用配置
  application:
    name: gobang-game-platform-test
  
  # 数据源配置
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://${DB_HOST:localhost}:${DB_PORT:3306}/${DB_NAME:java_gobang_test}?useSSL=true&serverTimezone=UTC&characterEncoding=utf8&useUnicode=true
    username: ${DB_USERNAME:root}
    password: ${DB_PASSWORD:123456}
    # 连接池配置
    hikari:
      minimum-idle: 10
      maximum-pool-size: 30
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
      connection-test-query: SELECT 1
  
  # Redis 配置
  redis:
    host: ${REDIS_HOST:localhost}
    port: ${REDIS_PORT:6379}
    password: ${REDIS_PASSWORD:}
    timeout: 5000ms
    database: 1 # 测试环境使用数据库1
    # 连接池配置
    lettuce:
      pool:
        max-active: 20
        max-idle: 10
        min-idle: 5
        max-wait: 2000ms
  
  # 缓存配置
  cache:
    type: redis
    redis:
      time-to-live: 900000 # 15分钟
      cache-null-values: false
      use-key-prefix: true
      key-prefix: gobang:test:cache
  
  # 会话配置
  session:
    store-type: redis
    timeout: 1800 # 30分钟
    redis:
      namespace: gobang:test:session
      flush-mode: on-save
  
  # 事务配置
  transaction:
    default-timeout: 30
    rollback-on-commit-failure: true
  
  # Jackson 配置
  jackson:
    date-format: yyyy-MM-dd HH:mm:ss
    time-zone: GMT+8
    default-property-inclusion: non_null
    serialization:
      write-dates-as-timestamps: false
      write-date-keys-as-timestamps: false

# 服务器配置
server:
  port: 8081 # 测试环境使用不同端口
  servlet:
    context-path: /
    encoding:
      charset: UTF-8
      enabled: true
      force: true
  tomcat:
    threads:
      max: 200
      min-spare: 10
    max-connections: 2000
    accept-count: 200
    connection-timeout: 20000ms
  compression:
    enabled: true
    mime-types: text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json,application/xml
    min-response-size: 1024

# 日志配置
logging:
  level:
    root: INFO
    org.example.gobang: DEBUG
    org.springframework.web: INFO
    org.springframework.security: INFO
    org.mybatis: DEBUG
    com.zaxxer.hikari: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level [%X{traceId}] %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level [%X{traceId}] %logger{36} - %msg%n"
  file:
    name: ${LOG_PATH:./logs}/gobang-test.log
    max-size: 100MB
    max-history: 14
    total-size-cap: 2GB

# MyBatis Plus 配置
mybatis-plus:
  configuration:
    map-underscore-to-camel-case: true
    cache-enabled: true
    lazy-loading-enabled: true
    multiple-result-sets-enabled: true
    use-column-label: true
    use-generated-keys: true
    auto-mapping-behavior: partial
    default-executor-type: reuse
    default-statement-timeout: 30
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
  global-config:
    db-config:
      id-type: auto
      logic-delete-field: deleted
      logic-delete-value: 1
      logic-not-delete-value: 0
    banner: false
  type-aliases-package: org.example.gobang.model

# JWT 配置
jwt:
  secret: ${JWT_SECRET:come-xiaqi-jwt-secret-key-2024-test-environment}
  expiration: 7200000 # 2小时
  header: Authorization
  prefix: Bearer
  issuer: gobang-platform
  audience: gobang-users

# 安全配置
security:
  # 忽略认证的URL
  ignored:
    urls:
      - "/api/user/login"
      - "/api/user/register"
      - "/api/test/**"
      - "/swagger-ui/**"
      - "/v3/api-docs/**"
      - "/actuator/health"
      - "/actuator/info"
      - "/error"
  
  # 加密配置
  password:
    encoder:
      strength: 8 # 测试环境使用中等强度
  
  # 会话安全
  session:
    fixation-protection: true
    concurrency-control:
      max-sessions: 5 # 测试环境限制会话数
      expired-url: /api/user/login?expired
    
  # CSRF保护
  csrf:
    enabled: true # 测试环境启用CSRF保护

# WebSocket 配置
websocket:
  endpoint: /ws
  allowed-origins: "*"
  max-message-size: 65536
  send-buffer-size: 524288
  receive-buffer-size: 524288
  keep-alive: true
  tcp-no-delay: true
  so-backlog: 100
  so-timeout: 30000

# 游戏配置
game:
  # 匹配配置
  match:
    timeout: 30 # 匹配超时时间（秒）
    max-wait-time: 120 # 最大等待时间（秒）
    min-players: 2
    max-players: 2
  
  # 游戏房间配置
  room:
    max-rooms: 500 # 最大房间数
    max-players-per-room: 2
    idle-timeout: 300 # 房间空闲超时（秒）
    cleanup-interval: 60 # 清理间隔（秒）
  
  # 积分配置
  score:
    initial-score: 1000
    win-score: 10
    lose-score: -5
    draw-score: 2
    max-score-change: 50
    min-score-change: 1
  
  # 游戏时长限制
  duration:
    max-game-time: 1800 # 最大游戏时长（秒）
    warning-time: 300 # 警告时间（秒）
    force-end-time: 3600 # 强制结束时间（秒）

# 监控配置
management:
  endpoints:
    web:
      exposure:
        include: "health,info,metrics,prometheus" # 测试环境只暴露必要端点
      base-path: /actuator
  endpoint:
    health:
      show-details: when-authorized
      show-components: when-authorized
    metrics:
      enabled: true
    prometheus:
      enabled: true
    env:
      enabled: false
    configprops:
      enabled: false
    loggers:
      enabled: true
    mappings:
      enabled: false
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${spring.application.name}
      environment: test

# 跨域配置
cors:
  allowed-origins: "${CORS_ALLOWED_ORIGINS:http://localhost:3000,http://localhost:8080}"
  allowed-methods: GET,POST,PUT,DELETE,OPTIONS,PATCH
  allowed-headers: "*"
  allow-credentials: true
  max-age: 3600

# 限流配置
rate-limit:
  enabled: true # 测试环境启用限流
  # 全局限流
  global:
    requests: 1000
    window: 60 # 秒
  # 用户限流
  user:
    requests: 100
    window: 60 # 秒
  # IP限流
  ip:
    requests: 50
    window: 60 # 秒

# 文件存储配置
storage:
  # 本地文件存储
  local:
    enabled: true
    base-path: ${STORAGE_PATH:./uploads}
    max-file-size: 10MB
  
  # MinIO 对象存储（可选）
  minio:
    enabled: false
    endpoint: ${MINIO_ENDPOINT:http://localhost:9000}
    access-key: ${MINIO_ACCESS_KEY:minioadmin}
    secret-key: ${MINIO_SECRET_KEY:minioadmin}
    bucket-name: ${MINIO_BUCKET:gobang-test-files}
    secure: ${MINIO_SECURE:false}

# 第三方服务配置
third-party:
  # 邮件服务
  email:
    enabled: true # 测试环境启用邮件服务
    host: ${EMAIL_HOST:smtp.gmail.com}
    port: ${EMAIL_PORT:587}
    username: ${EMAIL_USERNAME:}
    password: ${EMAIL_PASSWORD:}
    protocol: smtp
    properties:
      mail.smtp.auth: true
      mail.smtp.starttls.enable: true
  
  # 短信服务（可选）
  sms:
    enabled: false # 测试环境禁用短信服务
    provider: ${SMS_PROVIDER:aliyun}
    access-key: ${SMS_ACCESS_KEY:}
    secret-key: ${SMS_SECRET_KEY:}
    sign-name: ${SMS_SIGN_NAME:Come下棋}
  
  # 文件存储服务
  oss:
    enabled: false # 测试环境禁用OSS
    provider: ${OSS_PROVIDER:aliyun}
    endpoint: ${OSS_ENDPOINT:}
    access-key: ${OSS_ACCESS_KEY:}
    secret-key: ${OSS_SECRET_KEY:}
    bucket-name: ${OSS_BUCKET_NAME:}

# 系统配置
system:
  # 系统信息
  name: Come下棋
  version: 1.0.0-test
  environment: test
  
  # 维护模式
  maintenance:
    enabled: false
    message: 系统维护中，请稍后再试
    allow-admin: true
  
  # 公告配置
  announcement:
    enabled: true
    content: 欢迎来到Come下棋测试环境！
    type: info # info, warning, error
  
  # 统计配置
  statistics:
    enabled: true
    collect-interval: 300 # 秒
    retention-days: 30

# 测试配置
test:
  # 测试数据配置
  data:
    auto-cleanup: true # 测试结束后自动清理数据
    cleanup-interval: 3600 # 清理间隔（秒）
  
  # 测试用户配置
  users:
    auto-create: true # 自动创建测试用户
    count: 10 # 创建测试用户数量
    prefix: test_user_
    password: Test@123456
  
  # 性能测试配置
  performance:
    enabled: false # 默认禁用性能测试
    max-concurrent-users: 1000
    test-duration: 300 # 秒
    ramp-up-period: 60 # 秒