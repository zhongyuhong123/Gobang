# Come 下棋 - 生产环境配置
# 生产环境配置文件

spring:
  profiles:
    active: prod
  
  # 应用配置
  application:
    name: gobang-game-platform
  
  # 数据源配置
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://${DB_HOST:localhost}:${DB_PORT:3306}/${DB_NAME:gobang}?useSSL=true&serverTimezone=UTC&characterEncoding=utf8&useUnicode=true&allowPublicKeyRetrieval=true
    username: ${DB_USERNAME:gobang_user}
    password: ${DB_PASSWORD:gobang_password}
    # 连接池配置
    hikari:
      minimum-idle: 10
      maximum-pool-size: 50
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
      connection-test-query: SELECT 1
  
  # Redis 配置
  redis:
    host: ${REDIS_HOST:localhost}
    port: ${REDIS_PORT:6379}
    password: ${REDIS_PASSWORD:}
    timeout: 5000ms
    database: 0
    # 连接池配置
    lettuce:
      pool:
        max-active: 20
        max-idle: 10
        min-idle: 5
        max-wait: 1000ms
  
  # 缓存配置
  cache:
    type: redis
    redis:
      time-to-live: 3600000 # 1小时
      cache-null-values: false
      use-key-prefix: true
      key-prefix: gobang:cache
  
  # 会话配置
  session:
    store-type: redis
    timeout: 1800 # 30分钟
    redis:
      namespace: gobang:session
      flush-mode: on-save
  
  # 事务配置
  transaction:
    default-timeout: 30
    rollback-on-commit-failure: true
  
  # Jackson 配置
  jackson:
    date-format: yyyy-MM-dd HH:mm:ss
    time-zone: GMT+8
    default-property-inclusion: non_null
    serialization:
      write-dates-as-timestamps: false
      write-date-keys-as-timestamps: false
  
  # 文件上传配置
  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 50MB
      file-size-threshold: 2MB

# 服务器配置
server:
  port: ${SERVER_PORT:8080}
  servlet:
    context-path: ${CONTEXT_PATH:/}
    encoding:
      charset: UTF-8
      enabled: true
      force: true
  tomcat:
    threads:
      max: 200
      min-spare: 10
    max-connections: 8192
    accept-count: 100
    connection-timeout: 20000ms
  compression:
    enabled: true
    mime-types: text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json,application/xml
    min-response-size: 1024

# 日志配置
logging:
  level:
    root: ${LOG_LEVEL:INFO}
    com.yangshengzhou.gobang: DEBUG
    org.springframework.web: INFO
    org.springframework.security: INFO
    org.mybatis: DEBUG
    com.zaxxer.hikari: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level [%X{traceId}] %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level [%X{traceId}] %logger{36} - %msg%n"
  file:
    name: ${LOG_PATH:/app/logs}/gobang-prod.log
    max-size: 100MB
    max-history: 30
    total-size-cap: 3GB

# MyBatis Plus 配置
mybatis-plus:
  configuration:
    map-underscore-to-camel-case: true
    cache-enabled: true
    lazy-loading-enabled: true
    multiple-result-sets-enabled: true
    use-column-label: true
    use-generated-keys: true
    auto-mapping-behavior: partial
    default-executor-type: reuse
    default-statement-timeout: 30
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
  global-config:
    db-config:
      id-type: auto
      logic-delete-field: deleted
      logic-delete-value: 1
      logic-not-delete-value: 0
    banner: false
  type-aliases-package: com.yangshengzhou.gobang.entity

# JWT 配置
jwt:
  secret: ${JWT_SECRET:come-xiaqi-jwt-secret-key-2024-prod-environment}
  expiration: ${JWT_EXPIRATION:86400000} # 24小时
  header: Authorization
  prefix: Bearer
  issuer: gobang-platform
  audience: gobang-users

# 安全配置
security:
  # 忽略认证的URL
  ignored:
    urls:
      - "/user/login"
      - "/user/register"
      - "/user/info"
      - "/api/user/login"
      - "/api/user/register"
      - "/api/test/**"
      - "/swagger-ui/**"
      - "/v3/api-docs/**"
      - "/actuator/health"
      - "/ws/**"
  
  # 加密配置
  password:
    encoder:
      strength: 10 # BCrypt强度
  
  # 会话安全
  session:
    fixation-protection: true
    concurrency-control:
      max-sessions: 1
      expired-url: /api/user/login?expired
    
  # CSRF保护
  csrf:
    enabled: true
    header-name: X-XSRF-TOKEN
    cookie-name: XSRF-TOKEN

# WebSocket 配置
websocket:
  endpoint: /ws
  allowed-origins: "*"
  max-message-size: 65536
  send-buffer-size: 524288
  receive-buffer-size: 524288
  keep-alive: true
  tcp-no-delay: true
  so-backlog: 1000
  so-timeout: 30000

# 游戏配置
game:
  # 匹配配置
  match:
    timeout: 30 # 匹配超时时间（秒）
    max-wait-time: 300 # 最大等待时间（秒）
    min-players: 2
    max-players: 2
  
  # 游戏房间配置
  room:
    max-rooms: 10000 # 最大房间数
    max-players-per-room: 2
    idle-timeout: 1800 # 房间空闲超时（秒）
    cleanup-interval: 300 # 清理间隔（秒）
  
  # 积分配置
  score:
    initial-score: 1000
    win-score: 10
    lose-score: -5
    draw-score: 2
    max-score-change: 50
    min-score-change: 1
  
  # 游戏时长限制
  duration:
    max-game-time: 3600 # 最大游戏时长（秒）
    warning-time: 300 # 警告时间（秒）
    force-end-time: 7200 # 强制结束时间（秒）

# 监控配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
      base-path: /actuator
  endpoint:
    health:
      show-details: always
      show-components: always
    metrics:
      enabled: true
    prometheus:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${spring.application.name}
      environment: production

# 跨域配置
cors:
  allowed-origins: ${CORS_ORIGINS:http://localhost:3000,http://localhost:8080}
  allowed-methods: GET,POST,PUT,DELETE,OPTIONS
  allowed-headers: "*"
  allow-credentials: true
  max-age: 3600

# 限流配置
rate-limit:
  enabled: true
  # 全局限流
  global:
    requests: 1000
    window: 60 # 秒
  # 用户限流
  user:
    requests: 100
    window: 60 # 秒
  # IP限流
  ip:
    requests: 50
    window: 60 # 秒

# 文件存储配置
storage:
  # 本地文件存储
  local:
    enabled: true
    base-path: ${STORAGE_PATH:/app/uploads}
    max-file-size: 10MB
  
  # MinIO 对象存储（可选）
  minio:
    enabled: false
    endpoint: ${MINIO_ENDPOINT:http://localhost:9000}
    access-key: ${MINIO_ACCESS_KEY:}
    secret-key: ${MINIO_SECRET_KEY:}
    bucket-name: ${MINIO_BUCKET:gobang-files}
    secure: ${MINIO_SECURE:false}

# 第三方服务配置
third-party:
  # 邮件服务
  email:
    enabled: ${EMAIL_ENABLED:false}
    host: ${EMAIL_HOST:smtp.gmail.com}
    port: ${EMAIL_PORT:587}
    username: ${EMAIL_USERNAME:}
    password: ${EMAIL_PASSWORD:}
    protocol: smtp
    properties:
      mail.smtp.auth: true
      mail.smtp.starttls.enable: true
  
  # 短信服务（可选）
  sms:
    enabled: ${SMS_ENABLED:false}
    provider: ${SMS_PROVIDER:aliyun}
    access-key: ${SMS_ACCESS_KEY:}
    secret-key: ${SMS_SECRET_KEY:}
    sign-name: ${SMS_SIGN_NAME:Come下棋}
  
  # 文件存储服务
  oss:
    enabled: ${OSS_ENABLED:false}
    provider: ${OSS_PROVIDER:aliyun}
    endpoint: ${OSS_ENDPOINT:}
    access-key: ${OSS_ACCESS_KEY:}
    secret-key: ${OSS_SECRET_KEY:}
    bucket-name: ${OSS_BUCKET_NAME:}

# 系统配置
system:
  # 系统信息
  name: Come下棋
  version: 1.0.0
  environment: production
  
  # 维护模式
  maintenance:
    enabled: false
    message: 系统维护中，请稍后再试
    allow-admin: true
  
  # 公告配置
  announcement:
    enabled: true
    content: 欢迎来到Come下棋平台！
    type: info # info, warning, error
  
  # 统计配置
  statistics:
    enabled: true
    collect-interval: 300 # 秒
    retention-days: 90